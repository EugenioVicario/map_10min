<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weighted Mean Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 800px; width: 100%; margin-top: 10px; }
        #controls { padding: 10px; }
        .legend { background: white; padding: 10px; line-height: 18px; border-radius: 5px; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 1; }
        .custom-tooltip { background: white; border-radius: 4px; padding: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Weighted Mean Map</h2>
    <div id="controls">
        <label>Weight for Education: <input type="number" id="weightEdu" value="0.5" min="0" max="1" step="0.01"></label>
        <label>Weight for Health: <input type="number" id="weightHealth" value="0.5" min="0" max="1" step="0.01"></label>
        <label>Weight for Leisure: <input type="number" id="weightLeisure" value="0.5" min="0" max="1" step="0.01"></label>
        <label>Weight for Food Retail: <input type="number" id="weightFoodRetail" value="0.5" min="0" max="1" step="0.01"></label>
        <label>Weight for Primary Services: <input type="number" id="weightPrimarySe" value="0.5" min="0" max="1" step="0.01"></label>
        <label>Weight for Parks: <input type="number" id="weightParks" value="0.5" min="0" max="1" step="0.01"></label>
        <button onclick="updateMap()">Apply Weights</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([0, 0], 2);

        // Background map with opacity
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            opacity: 0.2
        }).addTo(map);

        var geojsonData;
        var geojsonLayer;
        var legend;

        function getColor(value, max) {
            let normalized = value ;
            return normalized > 0.8 ? '#800026' :
                   normalized > 0.6 ? '#BD0026' :
                   normalized > 0.4 ? '#E31A1C' :
                   normalized > 0.2 ? '#FC4E2A' : '#FFEDA0';
        }

        function updateMap() {
            let weightEdu = parseFloat(document.getElementById('weightEdu').value);
            let weightHealth = parseFloat(document.getElementById('weightHealth').value);
            let weightLeisure = parseFloat(document.getElementById('weightLeisure').value);
            let weightFoodRetail = parseFloat(document.getElementById('weightFoodRetail').value);
            let weightPrimarySe = parseFloat(document.getElementById('weightPrimarySe').value);
            let weightParks = parseFloat(document.getElementById('weightParks').value);
            
            let weightSum = weightEdu + weightHealth + weightLeisure + weightFoodRetail + weightPrimarySe + weightParks;
            let maxWeightedMean = weightSum;

            if (geojsonLayer) map.removeLayer(geojsonLayer);

            geojsonLayer = L.geoJSON(geojsonData, {
                style: function(feature) {
                    let weightedMean = (
                        feature.properties.Education * weightEdu +
                        feature.properties.Health * weightHealth +
                        feature.properties.Leisure * weightLeisure +
                        feature.properties.Food_Retai * weightFoodRetail +
                        feature.properties.Primary_Se * weightPrimarySe +
                        feature.properties.Parks * weightParks
                    ) / weightSum;

                    return { 
                        fillColor: getColor(weightedMean, maxWeightedMean),
                        fillOpacity: 1, 
                        color: "transparent", 
                        weight: 0 
                    };
                },
                onEachFeature: function(feature, layer) {
                    let weightedMean = (
                        feature.properties.Education * weightEdu +
                        feature.properties.Health * weightHealth +
                        feature.properties.Leisure * weightLeisure +
                        feature.properties.Food_Retai * weightFoodRetail +
                        feature.properties.Primary_Se * weightPrimarySe +
                        feature.properties.Parks * weightParks
                    ) / weightSum;

                    layer.on('click', function(e) {
                        // Remove existing tooltips
                        map.eachLayer(function(l) {
                            if (l.getTooltip()) {
                                l.unbindTooltip();
                            }
                        });

                        // Bind and show the tooltip
                        layer.bindTooltip(
                            `<b>Weighted Mean:</b> ${weightedMean.toFixed(2)}`,
                            { permanent: true, direction: "center", className: "custom-tooltip" }
                        ).openTooltip();

                        // Fix event propagation
                        L.DomEvent.stopPropagation(e);
                    });
                }
            }).addTo(map);

            // Remove tooltip when clicking outside polygons
            map.on('click', function() {
                map.eachLayer(function(layer) {
                    if (layer.getTooltip()) {
                        layer.unbindTooltip();
                    }
                });
            });

            var bounds = geojsonLayer.getBounds();
            map.fitBounds(bounds);

            updateLegend(maxWeightedMean);
        }

        function updateLegend(maxWeightedMean) {
            if (legend) map.removeControl(legend);

            legend = L.control({ position: "bottomright" });

            legend.onAdd = function () {
                var div = L.DomUtil.create("div", "info legend");
                var grades = [0, 0.2 , 0.4 , 0.6 , 0.8 ];
                var colors = ['#FFEDA0', '#FC4E2A', '#E31A1C', '#BD0026', '#800026'];

                for (var i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + colors[i] + '; width: 18px; height: 18px; display: inline-block;"></i> ' +
                        grades[i].toFixed(2) + (grades[i + 1] ? ' - ' + grades[i + 1].toFixed(2) + '<br>' : '+');
                }

                return div;
            };

            legend.addTo(map);
        }

        fetch('indicatore_02.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonData = data;
                updateMap();
            });
    </script>
</body>
</html>


